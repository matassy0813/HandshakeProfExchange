import SwiftUI
import CoreMotion
import CoreImage.CIFilterBuiltins
import UIKit

// MARK: - ÂÖ±ÊúâÂ±•Ê≠¥„Éá„Éº„Çø„É¢„Éá„É´
struct ShareLog: Codable, Identifiable {
    let id = UUID()
    let date: Date
    let method: String // "QR" or "AirDrop"
}

// MARK: - Â±•Ê≠¥ÁÆ°ÁêÜViewModel
class ShareLogViewModel: ObservableObject {
    @Published var logs: [ShareLog] = []
    private let key = "share_logs"

    init() {
        load()
    }

    func addLog(method: String) {
        let newLog = ShareLog(date: Date(), method: method)
        logs.append(newLog)
        save()
    }

    private func save() {
        if let data = try? JSONEncoder().encode(logs) {
            UserDefaults.standard.set(data, forKey: key)
        }
    }

    private func load() {
        if let data = UserDefaults.standard.data(forKey: key),
           let saved = try? JSONDecoder().decode([ShareLog].self, from: data) {
            logs = saved
        }
    }
    
    func clearLogs() {
        logs.removeAll()
        UserDefaults.standard.removeObject(forKey: key)
    }

}

// MARK: - „É°„Ç§„É≥„Éì„É•„Éº
struct ContentView: View {
    let motionManager = CMMotionManager()

    @State private var isSharing = false
    @State private var showQR = false
    @State private var didShake = false
    
    @AppStorage("userProfileURL") private var profileURL: String = ""
    @State private var isSettingURL = false
    @State private var tempURL: String = ""
    @State private var showMenu = false
    @State private var isLoading = true


    @StateObject private var logVM = ShareLogViewModel()

    var body: some View {
        ZStack(alignment: .leading) {
            ZStack {
                LinearGradient(gradient: Gradient(colors: [.pink.opacity(0.3), .blue.opacity(0.2)]),
                           startPoint: .topLeading,
                           endPoint: .bottomTrailing)
                .ignoresSafeArea()
                if isLoading {
                    VStack {
                        Spacer()
                        ProgressView("Ë™≠„ÅøËæº„Åø‰∏≠‚Ä¶")
                            .foregroundColor(.white)
                            .padding()
                        Spacer()
                    }
                }
                else {
                    VStack(spacing: 24) {
                        HStack {
                            Button(action: {
                                withAnimation {
                                    showMenu.toggle()
                                }
                            }) {
                                Image(systemName: "line.horizontal.3")
                                    .foregroundColor(.white)
                                    .padding()
                            }
                            Spacer()
                        }
                        Text("‚ú® Shake & Share ‚ú®")
                            .font(.largeTitle)
                            .bold()
                            .foregroundColor(.white)

                        if showQR {
                            renderQRCodeView()
                        } else if didShake {
                            renderShareOptionsView()
                        } else {
                            renderShakePrompt()
                        }

                        if !logVM.logs.isEmpty {
                            renderShareLogView()
                        }

                        Spacer()
                    }
                }
                    
                
            }
            .padding()
            .blur(radius: showMenu ? 5 : 0)
            .disabled(showMenu) // ‚Üê „É°„Éã„É•„ÉºË°®Á§∫‰∏≠„ÅØUI„ÇíÊìç‰Ωú‰∏çÂèØ„Å´„Åô„Çã
        
        // „Çµ„Ç§„Éâ„É°„Éã„É•„Éº
            if showMenu {
                    // ‚úÖ ËÉåÊôØ„Çø„ÉÉ„Éó„ÅßÈñâ„Åò„ÇãÈÄèÊòé„É¨„Ç§„É§„Éº
                    Color.black.opacity(0.001) // ‚Üê ÈùûË°®Á§∫„Å†„Åå„Çø„ÉÉ„ÉóÊ§úÂá∫„Åï„Çå„Çã
                        .ignoresSafeArea()
                        .onTapGesture {
                            withAnimation {
                                showMenu = false
                            }
                        }

                    // ‚úÖ Â∑¶ÂÅ¥„É°„Éã„É•„ÉºË°®Á§∫
                    renderSideMenu()
                        .transition(.move(edge: .leading))
            }
            
        }
        .onAppear {
            print("üåü onAppear start")
            isLoading = true

            DispatchQueue.main.asyncAfter(deadline: .now() + 0.3) {
                print("üõ† check & shake start")
                checkInitialURL()
                startShakeDetection()

                DispatchQueue.main.asyncAfter(deadline: .now() + 0.1) {
                    print("‚úÖ isLoading = false")
                    isLoading = false
                }
            }
        }
        .sheet(isPresented: $isSharing) {
            if let url = URL(string: profileURL), UIApplication.shared.canOpenURL(url) {
                ActivityView(activityItems: [url])
            } else {
                VStack {
                    Text("‚ö†Ô∏è URL„ÅåÁÑ°Âäπ„Åß„Åô„ÄÇË®≠ÂÆö„Åó„Å¶„Åè„Å†„Åï„ÅÑ")
                        .foregroundColor(.red)
                    Button("Ë®≠ÂÆö„Åô„Çã") {
                        tempURL = ""
                        isSettingURL = true
                        isSharing = false
                    }
                }
                .padding()
            }
        }
        .sheet(isPresented: $isSettingURL) {
            VStack(spacing: 20) {
                Text("„Éó„É≠„Éï„Ç£„Éº„É´URL„ÇíÂÖ•Âäõ")
                    .font(.headline)

                TextField("https://example.com", text: $tempURL)
                    .textFieldStyle(RoundedBorderTextFieldStyle())
                    .padding()

                Button("‰øùÂ≠ò„Åó„Å¶Èñâ„Åò„Çã") {
                    profileURL = tempURL
                    isSettingURL = false
                }
                .padding()
                .background(Color.blue.opacity(0.2))
                .cornerRadius(10)
            }
            .padding()
        }

    }

    func startShakeDetection() {
        guard motionManager.isAccelerometerAvailable else {
            print("‚ö†Ô∏è Âä†ÈÄüÂ∫¶„Çª„É≥„Çµ„Éº„Åå‰ΩøÁî®„Åß„Åç„Åæ„Åõ„Çì")
            return
        }

        motionManager.accelerometerUpdateInterval = 0.2
        motionManager.startAccelerometerUpdates(to: OperationQueue.main) { data, error in
            guard let acceleration = data?.acceleration else { return }
            if isShake(acceleration) {
                handleShake()
            }
        }
    }


    func isShake(_ acceleration: CMAcceleration) -> Bool {
        let threshold = 2.5
        return abs(acceleration.x) > threshold ||
               abs(acceleration.y) > threshold ||
               abs(acceleration.z) > threshold
    }
    
    

    func handleShake() {
        didShake = true
        motionManager.stopAccelerometerUpdates()
    }

    func showQRCode() {
        guard !profileURL.isEmpty else {
            tempURL = ""
            isSettingURL = true
            return
        }
        showQR = true
        logVM.addLog(method: "QR")
    }

    func shareViaAirDrop() {
        isSharing = true
        logVM.addLog(method: "AirDrop")
    }

    func returnToOptions() {
        showQR = false
    }

    func generateQRCode(from string: String) -> UIImage {
        guard !string.isEmpty else {
            return UIImage(systemName: "questionmark.circle") ?? UIImage()
        }

        let context = CIContext()
        let filter = CIFilter.qrCodeGenerator()
        let data = Data(string.utf8)
        filter.setValue(data, forKey: "inputMessage")

        if let outputImage = filter.outputImage {
            let scaledImage = outputImage.transformed(by: CGAffineTransform(scaleX: 10, y: 10))
            if let cgimg = context.createCGImage(scaledImage, from: scaledImage.extent) {
                return UIImage(cgImage: cgimg)
            }
        }

        return UIImage(systemName: "xmark.circle") ?? UIImage()
    }

    func checkInitialURL() {
        if profileURL.isEmpty {
            tempURL = ""
            isSettingURL = true
        }
    }

    func renderQRCodeView() -> some View {
        VStack(spacing: 16) {
            Spacer() // ‚Üê ‰∏ä„Å´‰ΩôÁôΩ„Çí‰Ωú„Å£„Å¶„ÄÅÂÖ®‰Ωì„Çí‰∏ã„Å´ÈÖçÁΩÆ

            Image(uiImage: generateQRCode(from: profileURL))
                .interpolation(.none)
                .resizable()
                .frame(width: 180, height: 180)
                .background(Color.white)
                .cornerRadius(8)
                .transition(.scale) // ‚Üê „Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ËøΩÂä†
                .animation(.easeInOut(duration: 0.3), value: showQR)

            Text("üì° QR„Ç≥„Éº„Éâ„ÅåË°®Á§∫„Åï„Çå„Åæ„Åó„Åü")
                .foregroundColor(.blue)

            Button(action: {
                withAnimation {
                    returnToOptions()
                }
            }) {
                Text("üîô Êàª„Çã")
                    .padding()
                    .background(Color.orange.opacity(0.2))
                    .cornerRadius(10)
            }

            Spacer(minLength: 50) // ‚Üê ‰∏ã„Å´„ÇÇÂ∞ë„Åó‰ΩôÁôΩ
        }
    }


    func renderShareOptionsView() -> some View {
        VStack(spacing: 16) {
            Button(action: {
                withAnimation(.easeInOut(duration: 0.3)) {
                    showQRCode()
                }
            }) {
                Text("üî≥ QR„Ç≥„Éº„Éâ„ÅßÂÖ±Êúâ")
                    .padding()
                    .background(Color.white)
                    .foregroundColor(.pink)
                    .cornerRadius(12)
            }
            .transition(.scale)
            .animation(.easeInOut, value: showQR)

            Button(action: {
                withAnimation(.easeInOut(duration: 0.3)) {
                    shareViaAirDrop()
                }
            }) {
                Text("üì° AirDrop„ÅßÈÄÅ‰ø°")
                    .padding()
                    .background(Color.white)
                    .foregroundColor(.blue)
                    .cornerRadius(12)
            }
            .transition(.scale)
            .animation(.easeInOut, value: isSharing)
        }
    }


    func renderShakePrompt() -> some View {
        VStack(spacing: 12) {
            Spacer() // üîΩ „Åì„Çå„ÇíËøΩÂä†„Åó„Å¶‰∏ä„ÅÆ‰ΩôÁôΩ„ÇíÁ¢∫‰øù

            Text("ü§ù iPhone„ÇíÊåØ„Å£„Å¶„ÄÅÂÖ±ÊúâÊñπÊ≥ï„ÇíÈÅ∏Êäû")
                .foregroundColor(.white)

            Button(action: {
                tempURL = profileURL
                isSettingURL = true
            }) {
                Text("üîß URL„ÇíË®≠ÂÆö")
                    .font(.caption)
                    .padding(6)
                    .background(Color.white.opacity(0.2))
                    .cornerRadius(8)
            }

            Spacer() // üîº „Åì„Çå„ÇíËøΩÂä†„Åó„Å¶‰∏ã„ÅÆ‰ΩôÁôΩ„ÇíÁ¢∫‰øù
        }
    }

    func renderShareLogView() -> some View {
        let recentLogs = logVM.logs.suffix(10).reversed()
        return VStack(alignment: .leading, spacing: 8) {
            Spacer(minLength: 20) // üîΩ ‰∏äÈÉ®„Å´„Çπ„Éö„Éº„ÇπËøΩÂä†Ôºà‰ªªÊÑèÔºâ

            HStack {
                Text("üìú ÂÖ±ÊúâÂ±•Ê≠¥")
                    .font(.headline)
                    .foregroundColor(.white)
                Spacer()
                Button(action: {
                    logVM.clearLogs()
                }) {
                    Text("üóëÔ∏è ÂÖ®ÂâäÈô§")
                        .font(.caption)
                        .foregroundColor(.red)
                }
            }
            ForEach(recentLogs) { log in
                Text("\(formatted(log.date))Ôºö\(log.method)")
                    .font(.caption)
                    .foregroundColor(.white)
            }

            Spacer(minLength: 50) // üîº ‰∏ã„Å´‰ΩôÁôΩ„ÇíËøΩÂä†Ôºà‰ªªÊÑèÔºâ
        }
    }

    
    func renderSideMenu() -> some View {
        VStack(alignment: .leading, spacing: 20) {
            Button("üîß URL„ÇíË®≠ÂÆö") {
                tempURL = profileURL
                isSettingURL = true
                withAnimation {
                    showMenu = false
                }
            }
            .padding(.top, 60)

            Button("‚ùå Èñâ„Åò„Çã") {
                withAnimation {
                    showMenu = false
                }
            }
            .foregroundColor(.red)

            Spacer()
        }
        .padding(.horizontal, 20)
        .frame(width: 200, alignment: .leading) // ‚Üê ÂπÖ„Çí200pt„Å´Âà∂ÈôêÔºàÁ¥Ñ5cmÁõ∏ÂΩìÔºâ
        .background(Color.black.opacity(0.9))
        .edgesIgnoringSafeArea(.all)
    }



    func formatted(_ date: Date) -> String {
        let formatter = DateFormatter()
        formatter.dateFormat = "yyyy/MM/dd HH:mm"
        return formatter.string(from: date)
    }
}

// MARK: - AirDropÁî®„ÅÆView
struct ActivityView: UIViewControllerRepresentable {
    var activityItems: [Any]
    var applicationActivities: [UIActivity]? = nil

    func makeUIViewController(context: Context) -> UIActivityViewController {
        UIActivityViewController(activityItems: activityItems, applicationActivities: applicationActivities)
    }

    func updateUIViewController(_ uiViewController: UIActivityViewController, context: Context) {}
}

